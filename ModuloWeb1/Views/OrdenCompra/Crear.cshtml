@model ModuloWeb1.Models.OrdenCompraViewModel
@{
    ViewData["Title"] = "Nueva Orden de Compra";
}

<div class="container mt-4">
    <div class="card shadow-lg p-4">
        <h2 class="text-center text-primary mb-4">
            Orden de Compra
        </h2>

        <form asp-action="Crear" method="post">

            <!-- PROVEEDOR + CONDICIONES -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Proveedor:</label>
                    <select id="proveedorSelect" name="IdProveedor" class="form-select"
                            onchange="filtrarProductosPorProveedor()" required>
                        <option value="">Seleccione un proveedor</option>
                        @foreach (var p in ViewBag.Proveedores)
                        {
                            <option value="@p.Id">@p.Nombre - @p.Direccion</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Condiciones de pago:</label>
                    <input type="text" name="Condiciones" class="form-control" value="30 d√≠as" />
                </div>
            </div>

            <hr />
            <h4 class="text-secondary">üõí Productos</h4>

            <div class="mb-2 text-muted">
                <small>
                    Puedes escoger un producto del cat√°logo <strong>o</strong> escribirlo manualmente con su valor.
                </small>
            </div>

            <!-- CONTENEDOR DE FILAS -->
            <div id="productos" class="mb-3">

                <!-- FILA MODELO -->
                <div class="row g-3 align-items-center mb-2 detalle border-bottom pb-2">

                    <!-- Modo producto (cat√°logo / manual) -->
                    <div class="col-12 mb-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input modo-catalogo" type="radio"
                                   name="modo_0" value="catalogo" checked
                                   onclick="cambiarModo(this)">
                            <label class="form-check-label">Cat√°logo</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input modo-manual" type="radio"
                                   name="modo_0" value="manual"
                                   onclick="cambiarModo(this)">
                            <label class="form-check-label">Manual</label>
                        </div>
                    </div>

                    <!-- Producto de cat√°logo -->
                    <div class="col-md-4 cont-catalogo">
                        <label class="form-label">Producto (cat√°logo)</label>
                        <select name="IdProducto" class="form-select producto-select"
                                onchange="actualizarPrecio(this)" required>
                            <option value="">Seleccione un producto</option>
                            @foreach (var pr in ViewBag.Productos)
                            {
                                <option value="@pr.Id"
                                        data-precio="@pr.Precio"
                                        data-proveedor="@pr.IdProveedor">
                                    @pr.Nombre
                                </option>
                            }
                        </select>
                    </div>

                    <!-- Producto manual -->
                    <div class="col-md-4 cont-manual d-none">
                        <label class="form-label">Producto (manual)</label>
                        <input type="text" name="NombreManual" class="form-control"
                               placeholder="Descripci√≥n del producto" />
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="Cantidad"
                               class="form-control cantidad-input"
                               min="1" value="1" required />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Precio Unitario</label>
                        <input type="number" step="0.01"
                               name="PrecioUnitario"
                               class="form-control precio-input"
                               readonly />
                    </div>

                    <div class="col-md-1 text-center">
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="button" class="btn btn-danger" onclick="eliminarFila(this)">
                            ‚ùå
                        </button>
                    </div>

                </div>

            </div>

            <button type="button" class="btn btn-outline-primary mb-3" onclick="agregarFila()">
                ‚ûï Agregar producto
            </button>

            <!-- TOTAL -->
            <div class="text-end fw-bold fs-5 mb-3">
                Total: $<span id="total">0.00</span>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn_SUCCESS px-4">üíæ Generar Orden</button>
            </div>
        </form>

        @if (ViewBag.Mensaje != null)
        {
            <div class="alert alert-success text-center mt-4">
                @ViewBag.Mensaje
            </div>
        }
    </div>
</div>

<!-- SELECT OCULTO CON TODOS LOS PRODUCTOS -->
<select id="productosMaster" class="d-none">
    <option value="">Seleccione un producto</option>
    @foreach (var pr in ViewBag.Productos)
    {
        <option value="@pr.Id"
                data-precio="@pr.Precio"
                data-proveedor="@pr.IdProveedor">
            @pr.Nombre
        </option>
    }
</select>

<script>
    // Clonar fila
    function agregarFila() {
        const original = document.querySelector(".detalle");
        const clone = original.cloneNode(true);

        // limpiar campos
        clone.querySelector("select[name='IdProducto']").selectedIndex = 0;
        clone.querySelector("input[name='NombreManual']").value = "";
        clone.querySelector("input[name='Cantidad']").value = 1;
        clone.querySelector("input[name='PrecioUnitario']").value = "";

        // reset modos
        const radios = clone.querySelectorAll(".form-check-input");
        radios.forEach(r => {
            r.name = "modo_" + document.querySelectorAll(".detalle").length; // nombre √∫nico por fila
            if (r.value === "catalogo") r.checked = true;
            else r.checked = false;
        });

        // mostrar cat√°logo / ocultar manual
        clone.querySelector(".cont-catalogo").classList.remove("d-none");
        clone.querySelector(".cont-manual").classList.add("d-none");
        clone.querySelector("select[name='IdProducto']").required = true;
        clone.querySelector("input[name='NombreManual']").required = false;
        clone.querySelector("input[name='PrecioUnitario']").readOnly = true;

        document.getElementById("productos").appendChild(clone);

        filtrarProductosPorProveedor();
    }

    // Eliminar fila
    function eliminarFila(btn) {
        const filas = document.querySelectorAll(".detalle");

        if (filas.length > 1) {
            btn.closest(".detalle").remove();
        } else {
            const fila = filas[0];
            fila.querySelector("select[name='IdProducto']").selectedIndex = 0;
            fila.querySelector("input[name='NombreManual']").value = "";
            fila.querySelector("input[name='Cantidad']").value = 1;
            fila.querySelector("input[name='PrecioUnitario']").value = "";
        }

        recalcularTotal();
    }

    // Cambiar entre cat√°logo / manual
    function cambiarModo(radio) {
        const fila = radio.closest(".detalle");
        const modo = radio.value;

        const contCatalogo = fila.querySelector(".cont-catalogo");
        const contManual = fila.querySelector(".cont-manual");
        const selectProd = fila.querySelector("select[name='IdProducto']");
        const inputNombre = fila.querySelector("input[name='NombreManual']");
        const inputPrecio = fila.querySelector("input[name='PrecioUnitario']");

        if (modo === "catalogo") {
            contCatalogo.classList.remove("d-none");
            contManual.classList.add("d-none");

            selectProd.required = true;
            inputNombre.required = false;

            // el precio se calcula desde el cat√°logo
            inputPrecio.readOnly = true;
            actualizarPrecio(selectProd);
        } else {
            contCatalogo.classList.add("d-none");
            contManual.classList.remove("d-none");

            selectProd.required = false;
            inputNombre.required = true;

            // en modo manual, el precio se escribe
            inputPrecio.readOnly = false;
            inputPrecio.value = "";
        }

        recalcularTotal();
    }

    // Filtrar productos por proveedor
    function filtrarProductosPorProveedor() {
        const idProveedor = document.getElementById("proveedorSelect").value;
        const master = document.querySelectorAll("#productosMaster option");

        document.querySelectorAll(".producto-select").forEach(select => {
            const valorPrevio = select.value;
            select.innerHTML = "";

            const o = document.createElement("option");
            o.value = "";
            o.textContent = "Seleccione un producto";
            select.appendChild(o);

            master.forEach(m => {
                if (!idProveedor || m.getAttribute("data-proveedor") === idProveedor) {
                    select.appendChild(m.cloneNode(true));
                }
            });

            Array.from(select.options).forEach(op => {
                if (op.value === valorPrevio) op.selected = true;
            });
        });
    }

    // Precio desde cat√°logo
    function actualizarPrecio(select) {
        const fila = select.closest(".detalle");
        const precio = select.selectedOptions[0]?.getAttribute("data-precio") || 0;
        const inputPrecio = fila.querySelector(".precio-input");

        // solo en modo cat√°logo
        const radioCatalogo = fila.querySelector(".modo-catalogo");
        if (radioCatalogo.checked) {
            inputPrecio.value = precio;
            recalcularTotal();
        }
    }

    // Recalcular total
    function recalcularTotal() {
        let total = 0;

        document.querySelectorAll(".detalle").forEach(fila => {
            const precio = parseFloat(fila.querySelector(".precio-input").value || 0);
            const cantidad = parseInt(fila.querySelector(".cantidad-input").value || 0);
            total += precio * cantidad;
        });

        document.getElementById("total").innerText = total.toFixed(2);
    }

    // Actualizar total al cambiar cantidad o precio manual
    document.addEventListener("input", function (e) {
        if (e.target.classList.contains("cantidad-input") ||
            (e.target.name === "PrecioUnitario")) {
            recalcularTotal();
        }
    });

    // Inicial: filtra productos y recalcula
    document.addEventListener("DOMContentLoaded", function () {
        filtrarProductosPorProveedor();
        recalcularTotal();
    });
</script>
