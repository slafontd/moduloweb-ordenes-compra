@model ModuloWeb1.Models.OrdenCompraViewModel
@{
    ViewData["Title"] = "Nueva Orden de Compra";
}

<div class="container mt-4">
    <div class="card shadow-lg p-4">
        <h2 class="text-center text-primary mb-4">
            Orden de Compra
        </h2>

        <form asp-action="Crear" method="post">

            <!-- PROVEEDOR + CONDICIONES -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Proveedor:</label>
                    <select id="proveedorSelect" name="IdProveedor" class="form-select" onchange="filtrarProductosPorProveedor()" required>
                        <option value="">Seleccione un proveedor</option>
                        @foreach (var p in ViewBag.Proveedores)
                        {
                            <option value="@p.Id">@p.Nombre - @p.Direccion</option>
                        }
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Condiciones de pago:</label>
                    <input type="text" name="Condiciones" class="form-control" value="30 d√≠as" />
                </div>
            </div>

            <hr />
            <h4 class="text-secondary">üõí Productos</h4>

            <!-- CONTENEDOR DE FILAS -->
            <div id="productos" class="mb-3">

                <!-- FILA MODELO -->
                <div class="row g-3 align-items-center mb-2 detalle border-bottom pb-2">
                    
                    <div class="col-md-4">
                        <label class="form-label">Producto</label>
                        <select name="IdProducto" class="form-select producto-select" onchange="actualizarPrecio(this)" required>
                            <option value="">Seleccione un producto</option>
                            @foreach (var pr in ViewBag.Productos)
                            {
                                <option value="@pr.Id"
                                        data-precio="@pr.Precio"
                                        data-proveedor="@pr.IdProveedor">
                                    @pr.Nombre
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="Cantidad" class="form-control cantidad-input" min="1" value="1" required />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Precio Unitario</label>
                        <input type="text" name="PrecioUnitario" class="form-control precio-input" readonly />
                    </div>

                    <div class="col-md-2 text-center">
                        <label class="form-label d-block">&nbsp;</label>
                        <button type="button" class="btn btn-danger" onclick="eliminarFila(this)">
                            ‚ùå
                        </button>
                    </div>

                </div>

            </div>

            <button type="button" class="btn btn-outline-primary mb-3" onclick="agregarFila()">
                ‚ûï Agregar producto
            </button>

            <!-- TOTAL -->
            <div class="text-end fw-bold fs-5 mb-3">
                Total: $<span id="total">0.00</span>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-success px-4">üíæ Generar Orden</button>
            </div>
        </form>

        @if (ViewBag.Mensaje != null)
        {
            <div class="alert alert-success text-center mt-4">
                @ViewBag.Mensaje
            </div>
        }
    </div>
</div>

<!-- SELECT OCULTO PARA FILTRO DE PRODUCTOS -->
<select id="productosMaster" class="d-none">
    <option value="">Seleccione un producto</option>
    @foreach (var pr in ViewBag.Productos)
    {
        <option value="@pr.Id" 
                data-precio="@pr.Precio"
                data-proveedor="@pr.IdProveedor">
            @pr.Nombre
        </option>
    }
</select>

<script>

    // DUPLICAR FILA
    function agregarFila() {
        const original = document.querySelector(".detalle");
        const clone = original.cloneNode(true);

        // limpiar valores
        clone.querySelector("select[name='IdProducto']").selectedIndex = 0;
        clone.querySelector("input[name='Cantidad']").value = 1;
        clone.querySelector("input[name='PrecioUnitario']").value = "";

        document.getElementById("productos").appendChild(clone);

        filtrarProductosPorProveedor();
    }

    //  ELIMINAR FILA
    function eliminarFila(btn) {
        const filas = document.querySelectorAll(".detalle");

        if (filas.length > 1) {
            btn.closest(".detalle").remove();
            recalcularTotal();
        } else {
            // Si solo queda 1 fila, limpiar valores
            const fila = filas[0];
            fila.querySelector("select[name='IdProducto']").selectedIndex = 0;
            fila.querySelector("input[name='Cantidad']").value = 1;
            fila.querySelector("input[name='PrecioUnitario']").value = "";
            recalcularTotal();
        }
    }

    //  Filtrar productos por proveedor
    function filtrarProductosPorProveedor() {
        const idProveedor = document.getElementById("proveedorSelect").value;
        const master = document.querySelectorAll("#productosMaster option");

        document.querySelectorAll(".producto-select").forEach(select => {

            const valorPrevio = select.value;
            select.innerHTML = "";

            const o = document.createElement("option");
            o.value = "";
            o.textContent = "Seleccione un producto";
            select.appendChild(o);

            master.forEach(m => {
                if (!idProveedor || m.getAttribute("data-proveedor") === idProveedor) {
                    select.appendChild(m.cloneNode(true));
                }
            });

            Array.from(select.options).forEach(op => {
                if (op.value === valorPrevio) op.selected = true;
            });
        });
    }

    // Actualizar precio al elegir producto
    function actualizarPrecio(select) {
        const precio = select.selectedOptions[0]?.getAttribute("data-precio") || 0;
        const fila = select.closest(".detalle");
        fila.querySelector(".precio-input").value = precio;
        recalcularTotal();
    }

    // Recalcular total
    function recalcularTotal() {
        let total = 0;

        document.querySelectorAll(".detalle").forEach(fila => {
            const precio = parseFloat(fila.querySelector(".precio-input").value || 0);
            const cantidad = parseInt(fila.querySelector(".cantidad-input").value || 0);
            total += precio * cantidad;
        });

        document.getElementById("total").innerText = total.toFixed(2);
    }

    // Actualizar total cuando cambia la cantidad
    document.addEventListener("input", function (e) {
        if (e.target.classList.contains("cantidad-input")) {
            recalcularTotal();
        }
    });

</script>
